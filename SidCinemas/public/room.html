<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SidCinemas Watch Room</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.dark { background:#0b0b0b; color:#fff; font-family:sans-serif; text-align:center; }
    .header { display:flex; justify-content:space-between; padding:10px 20px; }
    .player-box { margin-top:10px; display:flex; justify-content:center; align-items:center; height:60vh; }
    .controls { margin:20px; }
    .video-call video { width:150px; height:100px; object-fit:cover; border-radius:8px; margin:4px; }
    button { background:#222; color:#fff; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; }
    button:hover { background:#333; }
    input, select { padding:6px; border-radius:6px; border:none; }
  </style>
</head>
<body class="dark">
  <!-- ðŸ”¹ Header -->
  <div class="header">
    <span id="roomCodeBox">Room: <strong id="roomCode">---</strong></span>
    <button id="leaveRoom">âœ– Leave</button>
  </div>

  <!-- ðŸ”¹ Player area -->
  <div id="playerBox" class="player-box">
    <p id="placeholder">ðŸŽ¬ Waiting for video...</p>
  </div>

  <!-- ðŸ”¹ Controls -->
  <div id="controls" class="controls">
    <select id="videoType">
      <option value="youtube">ðŸŽ¥ YouTube</option>
      <option value="movie">ðŸŽ¬ Movie</option>
    </select>
    <input id="videoInput" placeholder="Enter YouTube link or TMDb ID" />
    <button id="setVideo" class="accent">â–¶ Play</button>
  </div>

  <!-- ðŸ”¹ Video call section -->
  <div id="videos" class="video-call">
    <video id="localVideo" autoplay muted></video>
  </div>

  <!-- ðŸ”¹ Script logic -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
  window.addEventListener("DOMContentLoaded", () => {

    const socket = io();
    const params = new URLSearchParams(location.search);
    const code = params.get("room");
    const initType = params.get("type");
    const initData = params.get("data");

    // Wait until the #roomCode element exists before setting
    const waitForRoomCode = setInterval(() => {
      const roomEl = document.getElementById("roomCode");
      if (roomEl) {
        clearInterval(waitForRoomCode);
        roomEl.innerText = code;
        socket.emit("join-room", code);
      }
    }, 100);

    const videoContainer = document.getElementById("videos");
    const playerBox = document.getElementById("playerBox");
    let localStream;
    const peers = {};

    // Local video preview
    navigator.mediaDevices.getUserMedia({ video:true, audio:true })
    .then(stream => {
      localStream = stream;
      document.getElementById("localVideo").srcObject = stream;
    }).catch(err => console.error("Camera error:", err));

    // --- video player management ---
    let currentType;
    let ytPlayer;
    let html5Player;
    let ignoreEvents = false;

    function loadVideo(type, data) {
      document.getElementById("placeholder").style.display="none";
      currentType = type;
      if (type === "youtube") {
        const id = data.split("v=")[1]?.split("&")[0] || data;
        playerBox.innerHTML =
          `<iframe id="ytFrame" src="https://www.youtube.com/embed/${id}?enablejsapi=1&autoplay=1" allowfullscreen></iframe>`;
      } else {
        playerBox.innerHTML =
          `<iframe id="vsFrame" src="https://vidsrc.to/embed/movie/${data}" allowfullscreen></iframe>`;
      }
    }

    // Handle video set event
    socket.on("video-set", (type, data) => {
      loadVideo(type, data);
    });

    if (initType && initData) loadVideo(initType, initData);

    document.getElementById("setVideo").onclick = () => {
      const type = document.getElementById("videoType").value;
      const data = document.getElementById("videoInput").value.trim();
      if (data) socket.emit("set-video", code, type, data);
    };

    // WebRTC (minimal)
    socket.on("new-user", async (userId)=>{
      const pc=createPeer(userId);
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer",code,offer,userId);
    });
    socket.on("offer",async(offer,senderId)=>{
      const pc=createPeer(senderId);
      await pc.setRemoteDescription(offer);
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer",code,answer,senderId);
    });
    socket.on("answer",async(answer,senderId)=>{
      const pc=peers[senderId];
      if(pc)await pc.setRemoteDescription(answer);
    });
    socket.on("candidate",(cand,senderId)=>{
      const pc=peers[senderId];
      if(pc)pc.addIceCandidate(new RTCIceCandidate(cand));
    });

    function createPeer(targetId){
      const pc=new RTCPeerConnection();
      peers[targetId]=pc;
      localStream?.getTracks().forEach(track=>pc.addTrack(track,localStream));
      pc.onicecandidate=e=>{
        if(e.candidate)socket.emit("candidate",code,e.candidate,targetId);
      };
      pc.ontrack=e=>{
        if(!document.getElementById(targetId)){
          const vid=document.createElement("video");
          vid.id=targetId;
          vid.autoplay=true;
          vid.srcObject=e.streams[0];
          videoContainer.appendChild(vid);
        }
      };
      return pc;
    }

    document.getElementById("leaveRoom").onclick = () => {
      window.location.href = "/";
    };
  });
  </script>
</body>
</html>
