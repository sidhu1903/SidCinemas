<script src="/socket.io/socket.io.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
window.addEventListener("DOMContentLoaded", () => {

  const socket = io();
  const params = new URLSearchParams(location.search);
  const code = params.get("room");
  const initType = params.get("type");
  const initData = params.get("data");
  document.getElementById("roomCode").innerText = code;
  socket.emit("join-room", code);

  const videoContainer = document.getElementById("videos");
  const playerBox = document.getElementById("playerBox");
  let localStream;
  const peers = {};

  // --- local video (voice/video chat) ---
  navigator.mediaDevices.getUserMedia({ video:true, audio:true }).then(stream=>{
    localStream = stream;
    document.getElementById("localVideo").srcObject = stream;
  });

  // --- video player management ---
  let currentType;
  let ytPlayer;
  let html5Player;
  let ignoreEvents = false;

  function loadVideo(type, data) {
    document.getElementById("placeholder").style.display="none";
    currentType = type;

    if (type === "youtube") {
      const id = data.split("v=")[1]?.split("&")[0] || data;
      playerBox.innerHTML =
        `<iframe id="ytFrame" src="https://www.youtube.com/embed/${id}?enablejsapi=1&autoplay=1" allowfullscreen></iframe>`;
      onYouTubeIframeAPIReady(); // initialise sync
    } else {
      playerBox.innerHTML =
        `<iframe id="vsFrame" src="https://vidsrc.to/embed/movie/${data}" allowfullscreen></iframe>`;
      setupVidSrcSync();
    }
  }

  // wait for the iframe to load fully before syncing
  socket.on("video-set", (type, data) => {
    loadVideo(type, data);

    const iframe = document.querySelector("iframe");
    if (iframe) {
      iframe.addEventListener("load", () => {
        if (type === "youtube") onYouTubeIframeAPIReady();
        else setupVidSrcSync();
      });
    }
  });

  if (initType && initData) loadVideo(initType, initData);

  document.getElementById("setVideo").onclick = () => {
    const type = document.getElementById("videoType").value;
    const data = document.getElementById("videoInput").value.trim();
    if (data) socket.emit("set-video", code, type, data);
  };

  // ---------- YouTube Sync ----------
  function onYouTubeIframeAPIReady() {
    const iframe = document.getElementById("ytFrame");
    if (!iframe) return;

    ytPlayer = new YT.Player(iframe, {
      events: { onStateChange: onYTStateChange }
    });
  }

  function onYTStateChange(e) {
    if (ignoreEvents) return;
    const t = ytPlayer.getCurrentTime();
    if (e.data === YT.PlayerState.PLAYING)
      socket.emit("play-video", code, t);
    else if (e.data === YT.PlayerState.PAUSED)
      socket.emit("pause-video", code, t);
  }

  // ---------- VidSrc (HTML5) Sync ----------
  function setupVidSrcSync() {
    const iframe = document.getElementById("vsFrame");
    iframe.addEventListener("load", () => {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        html5Player = doc.querySelector("video");
        if (!html5Player) return;

        html5Player.addEventListener("play", () => {
          if (!ignoreEvents) socket.emit("play-video", code, html5Player.currentTime);
        });
        html5Player.addEventListener("pause", () => {
          if (!ignoreEvents) socket.emit("pause-video", code, html5Player.currentTime);
        });
        html5Player.addEventListener("seeked", () => {
          if (!ignoreEvents) socket.emit("seek-video", code, html5Player.currentTime);
        });
      } catch (err) {
        console.warn("VidSrc video sync unavailable (CORS):", err);
      }
    });
  }

  // ---------- Receive sync events ----------
  socket.on("play-video", time => syncPlay(time));
  socket.on("pause-video", time => syncPause(time));
  socket.on("seek-video", time => syncSeek(time));

  function syncPlay(time) {
    ignoreEvents = true;
    if (currentType === "youtube" && ytPlayer) {
      ytPlayer.seekTo(time, true);
      ytPlayer.playVideo();
    } else if (html5Player) {
      html5Player.currentTime = time;
      html5Player.play();
    }
    setTimeout(()=>ignoreEvents=false,500);
  }

  function syncPause(time) {
    ignoreEvents = true;
    if (currentType === "youtube" && ytPlayer) {
      ytPlayer.seekTo(time, true);
      ytPlayer.pauseVideo();
    } else if (html5Player) {
      html5Player.currentTime = time;
      html5Player.pause();
    }
    setTimeout(()=>ignoreEvents=false,500);
  }

  function syncSeek(time) {
    ignoreEvents = true;
    if (currentType === "youtube" && ytPlayer) {
      ytPlayer.seekTo(time, true);
    } else if (html5Player) {
      html5Player.currentTime = time;
    }
    setTimeout(()=>ignoreEvents=false,500);
  }

  // --- video call (existing logic) ---
  socket.on("new-user", async (userId)=>{
    const pc=createPeer(userId);
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer",code,offer,userId);
  });
  socket.on("offer",async(offer,senderId)=>{
    const pc=createPeer(senderId);
    await pc.setRemoteDescription(offer);
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("answer",code,answer,senderId);
  });
  socket.on("answer",async(answer,senderId)=>{
    const pc=peers[senderId];
    if(pc)await pc.setRemoteDescription(answer);
  });
  socket.on("candidate",(cand,senderId)=>{
    const pc=peers[senderId];
    if(pc)pc.addIceCandidate(new RTCIceCandidate(cand));
  });

  function createPeer(targetId){
    const pc=new RTCPeerConnection();
    peers[targetId]=pc;
    localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
    pc.onicecandidate=e=>{
      if(e.candidate)socket.emit("candidate",code,e.candidate,targetId);
    };
    pc.ontrack=e=>{
      if(!document.getElementById(targetId)){
        const vid=document.createElement("video");
        vid.id=targetId;
        vid.autoplay=true;
        vid.srcObject=e.streams[0];
        videoContainer.appendChild(vid);
      }
    };
    return pc;
  }

  document.getElementById("leaveRoom").onclick = () => {
    window.location.href = "/";
  };

}); // END of DOMContentLoaded
</script>
